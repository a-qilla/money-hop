{% extends "base.html" %}

{% block title %}Buku Besar{% endblock %}

{% block content %}
<div class="header">
    <h1>Buku Besar</h1>
    <p>Lihat detail transaksi per akun</p>
</div>

<div class="card">
    <div class="card-header">
        <h2>Pilih Akun</h2>
    </div>
    <div class="card-body">
        <form method="GET" action="{{ url_for('ledger') }}">
            <div class="form-group">
                <label class="form-label">Pilih Akun</label>
                <select name="account_code" class="form-control" onchange="this.form.submit()">
                    <option value="">-- Pilih Akun --</option>
                    {% for account in accounts %}
                    <option value="{{ account['code'] }}" 
                            {% if account['code'] == selected_account %}selected{% endif %}>
                        {{ account['code'] }} - {{ account['name'] }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </form>
        
        {% if selected_account %}
            <div style="margin-top: 1rem; padding: 1rem; background: var(--gray-50); border-radius: 6px;">
                <h3>Saldo Akun: 
                    {% for account in accounts %}
                        {% if account['code'] == selected_account %}
                            {{ account['name'] }}
                        {% endif %}
                    {% endfor %}
                </h3>
                <p class="text-money" style="font-size: 1.25rem; font-weight: bold;">
                    {{ get_account_balance(selected_account) | money_format }}
                </p>
            </div>
        {% endif %}
    </div>
</div>

{% if selected_account and ledger_data %}
<div class="card">
    <div class="card-header">
        <h2>Transaksi untuk Akun: {{ selected_account }}</h2>
    </div>
    <div class="card-body">
        <table class="table">
            <thead>
                <tr>
                    <th>Tanggal</th>
                    <th>No. Entri</th>
                    <th>Deskripsi</th>
                    <th>Debit</th>
                    <th>Kredit</th>
                    <th>Saldo</th>
                </tr>
            </thead>
            <tbody>
                {% set running_balance = 0 %}
                {% for entry in ledger_data %}
                    {% if selected_account.startswith('1') or selected_account.startswith('5') %}
                        {# Asset & Expense: Debit increase, Credit decrease #}
                        {% set running_balance = running_balance + entry['debit'] - entry['credit'] %}
                    {% else %}
                        {# Liability, Equity, Revenue: Credit increase, Debit decrease #}
                        {% set running_balance = running_balance + entry['credit'] - entry['debit'] %}
                    {% endif %}
                    
                    <tr>
                        <td>{{ entry['date'] }}</td>
                        <td>{{ entry['entry_no'] }}</td>
                        <td>{{ entry['description'] }}</td>
                        <td class="text-money">
                            {% if entry['debit'] > 0 %}
                                {{ entry['debit'] | money_format }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="text-money">
                            {% if entry['credit'] > 0 %}
                                {{ entry['credit'] | money_format }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="text-money" style="font-weight: bold;">
                            {{ running_balance | money_format }}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% elif selected_account and not ledger_data %}
<div class="card">
    <div class="card-body">
        <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
            <p>Tidak ada transaksi untuk akun ini.</p>
        </div>
    </div>
</div>
{% endif %}

<style>
.table th {
    background: var(--gray-50);
    position: sticky;
    top: 0;
}
</style>
{% endblock %}